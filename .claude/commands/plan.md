---
allowed-tools: Bash, Read, Glob, Grep, Task
description: Research an issue and add implementation notes
argument-hint: <issue-number>
---

Research an issue thoroughly and add implementation notes as a GitHub comment.

This helps autonomous Claude sessions (and humans) understand *where* and *how* to implement, not just *what* to do.

Usage:
- `/plan 42` - Research issue #42 and add implementation notes
- Auto-runs with `/clone --auto` and `/clone --full-auto` if no implementation notes exist

## Steps

1. **Parse the issue number:**
   ```bash
   ISSUE_NUM="$1"
   ```
   - If empty, try to extract from current branch:
     ```bash
     BRANCH=$(git branch --show-current)
     ISSUE_NUM=$(echo "$BRANCH" | grep -oE '[0-9]+' | head -1)
     ```
   - If still empty, show error and STOP

2. **Get GitHub repo info (handle clones):**
   ```bash
   if [ -f ".clone-info" ]; then
     SOURCE_REPO=$(grep '^source=' .clone-info | cut -d= -f2)
     REPO_SLUG=$(cd "$SOURCE_REPO" && gh repo view --json nameWithOwner -q .nameWithOwner)
   else
     REPO_SLUG=$(gh repo view --json nameWithOwner -q .nameWithOwner)
   fi
   ```

3. **Fetch issue details:**
   ```bash
   gh issue view "$ISSUE_NUM" --repo "$REPO_SLUG" --json title,body,labels,comments
   ```

4. **Check if implementation notes already exist:**
   - Look for a comment containing "## Implementation Notes"
   - If found, show: "Implementation notes already exist for #$ISSUE_NUM"
   - Ask: "Update them?" - if no, STOP

5. **Extract key information from the issue:**
   - What needs to be done (from title and body)
   - Acceptance criteria (if listed)
   - Area labels (area:combat, area:ui, etc.)

6. **Research the codebase using the Explore agent:**

   Use the Task tool with `subagent_type: "Explore"` to find:

   a. **Files to modify** - Find the specific files that need changes:
      - Search for related class names, functions, or patterns mentioned in the issue
      - Look in the area suggested by labels (e.g., `area:combat` -> `scripts/units/states/`)
      - Find where similar features are implemented

   b. **Related patterns** - Find examples to follow:
      - Search for similar implementations in the codebase
      - Find how adjacent features were built
      - Identify shared utilities or base classes to use

   c. **Potential gotchas** - Check for:
      - Special validation requirements (see CLAUDE.md gotchas)
      - Related tests that might need updating
      - Constants that should be used

7. **Format the implementation notes:**

   ```markdown
   ## Implementation Notes

   **Files to modify:**
   - `path/to/file.gd` - Brief description of what to change
   - `path/to/other.gd` - Brief description

   **Related patterns:**
   - See `path/to/example.gd:45-60` for similar implementation
   - Follow pattern used in `other_file.gd`

   **Gotchas:**
   - Remember to use constants for X
   - Must handle case where Z is null
   - Update related test file

   **Suggested approach:**
   1. First step
   2. Second step
   3. Run tests to verify

   ---
   *Auto-generated by `/plan` - update if approach changes*
   ```

8. **Post as GitHub comment:**
   ```bash
   gh issue comment "$ISSUE_NUM" --repo "$REPO_SLUG" --body "$(cat <<'EOF'
   <implementation notes here>
   EOF
   )"
   ```

9. **Confirm:**
   ```
   Implementation notes added to issue #<number>.

   View: gh issue view <number> --comments
   ```

## Quality Guidelines

- **Be specific** - "modify attack_state.gd" not "modify the attack code"
- **Include line numbers** - "see `gather_state.gd:45-60`" helps navigation
- **List constants** - If constant values should be used, name them
- **Note tests** - If tests exist or need creating, mention the test file
- **Keep it concise** - This is a roadmap, not full documentation
